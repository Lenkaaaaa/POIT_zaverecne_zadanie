<!DOCTYPE html>
<html lang="sk">
<head>
  <meta charset="UTF-8">
  <title>Monitorovanie DHT11</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-gauges/gauge.min.js"></script>
</head>
<body class="container py-4">
  <h1 class="mb-4">Monitorovanie teploty a vlhkosti</h1>

  <!-- Ovládacie tlačidlá -->
  <div class="mb-4">
    <button class="btn btn-secondary" onclick="sendCommand('open_system')">Open</button>
    <button class="btn btn-success" onclick="sendCommand('start_monitoring')">Start</button>
    <button class="btn btn-warning" onclick="sendCommand('stop_monitoring')">Stop</button>
    <button class="btn btn-danger" onclick="sendCommand('close_system')">Close</button>
    <p class="mt-2"><strong>Status:</strong> <span id="status-text">—</span></p>
  </div>

  <!-- Ciferníky -->
  <div class="row text-center mb-4">
    <div class="col-md-6">
      <p><strong>Teplota:</strong> <span id="temp-text">--</span> °C</p>
      <canvas id="tempGauge" width="250" height="250"></canvas>
    </div>
    <div class="col-md-6">
      <p><strong>Vlhkosť:</strong> <span id="hum-text">--</span> %</p>
      <canvas id="humGauge" width="250" height="250"></canvas>
    </div>
  </div>

  <!-- Tabuľka -->
  <h4>Tabuľka posledných hodnôt</h4>
  <table class="table table-bordered">
    <thead><tr><th>Čas</th><th>Teplota (°C)</th><th>Vlhkosť (%)</th></tr></thead>
    <tbody id="data-table"></tbody>
  </table>

  <!-- Graf -->
  <h4 class="mt-5">Graf</h4>
  <canvas id="sensorChart" height="100"></canvas>

  <script>
    const socket = io();
    const table = document.getElementById("data-table");
    const statusText = document.getElementById("status-text");

    function sendCommand(cmd) {
      socket.emit(cmd);

      // Ak bol stlačený "Close", resetujeme vizualizácie
      if (cmd === "close_system") {
        resetDisplay();
      }
    }

    function resetDisplay() {
      // Reset textov a ciferníkov
      document.getElementById("temp-text").innerText = "--";
      document.getElementById("hum-text").innerText = "--";
      tempGauge.value = 0;
      humGauge.value = 0;

      // Vymazanie tabuľky
      table.innerHTML = "";

      // Reset grafu
      chart.data.labels = [];
      chart.data.datasets.forEach(ds => ds.data = []);
      chart.update();
    }

    const chart = new Chart(document.getElementById("sensorChart").getContext("2d"), {
      type: "line",
      data: {
        labels: [],
        datasets: [
          { label: "Teplota (°C)", data: [], borderColor: "red", fill: false },
          { label: "Vlhkosť (%)", data: [], borderColor: "blue", fill: false }
        ]
      },
      options: {
        responsive: true,
        scales: { y: { beginAtZero: true } }
      }
    });

    const tempGauge = new RadialGauge({
      renderTo: "tempGauge",
      minValue: 0,
      maxValue: 50,
      units: "°C",
      value: 0,
      majorTicks: ["0","10","20","30","40","50"],
      animation: true
    }).draw();

    const humGauge = new RadialGauge({
      renderTo: "humGauge",
      minValue: 0,
      maxValue: 100,
      units: "%",
      value: 0,
      majorTicks: ["0","20","40","60","80","100"],
      animation: true
    }).draw();

    socket.on("new_data", (data) => {
      const time = new Date(data.cas).toLocaleTimeString('sk-SK');
      const temp = data.teplota;
      const hum = data.vlhkost;

      document.getElementById("temp-text").innerText = temp;
      document.getElementById("hum-text").innerText = hum;
      tempGauge.value = temp;
      humGauge.value = hum;

      const row = `<tr><td>${time}</td><td>${temp}</td><td>${hum}</td></tr>`;
      table.insertAdjacentHTML("afterbegin", row);
      if (table.rows.length > 10) table.deleteRow(-1);

      chart.data.labels.push(time);
      chart.data.datasets[0].data.push(temp);
      chart.data.datasets[1].data.push(hum);
      if (chart.data.labels.length > 20) {
        chart.data.labels.shift();
        chart.data.datasets[0].data.shift();
        chart.data.datasets[1].data.shift();
      }
      chart.update();
    });

    socket.on("status_update", (data) => {
      statusText.textContent = data.status;
    });
  </script>
</body>
</html>
